<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todos lis - UET</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/jquery.timepicker.css">
    <style>
        .todo p {
            border-bottom: 1px solid #fff;
            padding-bottom: 30px;
        }

        #page {
            background-color: #eee;
            min-height: 700px;
        }
    </style>
</head>
<body>
<div id="page" class="container">

    <h1 class="text-center">Todos list</h1>
    <div class="row">
        <div class="col-md-6 col-md-offset-3 col-sm-12 col-sm-offset-0">
            <form action="/insert" method="POST">
                <div class="form-group">
                    <input type="text" class="form-control" name="title" placeholder="Title">
                </div>

                <div class="form-group">
                    <textarea name="content" rows="3" class="form-control" placeholder="Take a note"></textarea>
                </div>

                <div class="form-group">
                    <button class="btn btn-success td-add">Done</button>
                </div>
            </form>
        </div>
    </div>

    <div class="td-lists row"></div>
</div>

<script src="/js/jquery.min.js"></script>
<script src="/js/socket.io.js"></script>
<script src="/js/jquery.timepicker.min.js"></script>
<script>
    jQuery(document).ready(function ($) {
        var socket = io();
        socket.on('add_todo', function (id) {
            var url_ajax = url_get_todo + id;
            console.log(id);

            $.ajax({
                url: url_ajax,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    var t = data;

                    var str = t.content.replace(/(?:\r\n|\r|\n)/g, '<br />');
                    var html = '<div id="' + t._id + '" class="col-md-6 col-md-offset-3 col-sm-12 col-sm-offset-0 todo">'
                            + '<h3>' + t.title + '<sub class="close pull-right td-delete" data-id="' + t._id + '">&times;</sub></h3>'
                            + '<p>' + str + '</p>'
                            + '</div>';

                    $todo_lists.prepend(html);
                }
            });
        });

        var url_get_all = location.href + 'all';
        var url_delete = location.href + 'delete/';
        var url_insert = location.href + 'insert';
        var url_get_todo = location.href + 'todo/';
        var $todo_lists = $('.td-lists');
        $.ajax({
            url: url_get_all,
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    var t = data[i];
                    var str = t.content.replace(/(?:\r\n|\r|\n)/g, '<br />');

                    var html = '<div id="' + t._id + '" class="col-md-6 col-md-offset-3 col-sm-12 col-sm-offset-0 todo">'
                            + '<h3>' + t.title + '<sub class="close pull-right td-delete" data-id="' + t._id + '">&times;</sub></h3>'
                            + '<p>' + str + '</p>'
                            + '</div>';

                    $todo_lists.prepend(html);
                }
            }
        });

        $('body').on('click', '.td-delete', function (e) {
            var id = $(this).data('id');
            var url_ajax = url_delete + id;

            $.ajax({
                url: url_ajax,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    if (data.return) {
                        $('#' + id).remove();
                    }
                }
            });
        });

        $('.td-add').on('click', function (e) {
            e.preventDefault();
            var title = $('[name="title"]').val();
            var content = $('[name="content"]').val();

            $.ajax({
                url: url_insert,
                method: 'POST',
                dataType: 'json',
                data: {title: title, content: content},
                success: function (data) {
                    if (data.return) {
                        $('[name="title"]').val('');
                        $('[name="content"]').val('');

                        var t = data.response;
                        socket.emit('add_todo', t._id);
                    } else {
                        alert('Something went wrong ~_~!');
                    }
                }
            });

        });

    });
</script>
</body>
</html>